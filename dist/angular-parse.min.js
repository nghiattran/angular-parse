"use strict";angular.module("parseServices",[]).service("parseServices",function e(r,t,s){function o(e){switch(e.code){case Parse.Error.INVALID_SESSION_TOKEN:Parse.User.logOut()}}var n={include:"_include",limit:"_limit",skip:"_skip",where:"_where",select:"_select",order:"_order"},a={};e.prototype.setKeysSimple=function(e,r){Parse.initialize(e,r)},e.prototype.setPointerMappingSimple=function(e){a=e},e.prototype.encodeQuery=function(r){for(var t=Object.keys(r),s=0;s<t.length;s++)a[t[s]]&&(r[t[s]]={__type:"Pointer",className:a[t[s]],objectId:r[t[s]]}),r[t[s]]._source&&r[t[s]]._source.file||"object"==typeof r[t[s]]&&e.prototype.encodeQuery(r[t[s]]);return r},e.prototype.decodeData=function(r){var t={};"object"==typeof r&&null!==r&&(t=Object.keys(r));for(var s=0;s<t.length;s++)a[t[s]]&&1==Object.keys(r[t[s]]).length?r[t[s]]=r[t[s]].objectId:"object"==typeof r[t[s]]&&(r[t[s]]._url?r[t[s]]={url:r[t[s]]._url,name:r[t[s]]._name}:e.prototype.decodeData(r[t[s]]));return r},e.prototype.stripArray=function(r){for(var t=[],s=[],o=0;o<r.length;o++){var n={};s[o]=Object.keys(r[o].attributes),n.objectId=r[o].id;for(var a=0;a<s[o].length;a++)r[o].attributes[s[o][a]]&&r[o].attributes[s[o][a]].attributes?n[s[o][a]]=e.prototype.stripObject(r[o].attributes[s[o][a]]):n[s[o][a]]=r[o].attributes[s[o][a]];t.push(n)}return t},e.prototype.stripObject=function(r){var t={},s=Object.keys(r.attributes);t.objectId=r.id;for(var o=0;o<s.length;o++)t[s[o]]=r.attributes[s[o]],r.attributes[s[o]]&&r.attributes[s[o]].attributes?t[s[o]]=e.prototype.stripObject(r.attributes[s[o]]):t[s[o]]=r.attributes[s[o]];return t},e.prototype.signup=function(s){var n=t.defer(),c=new Parse.User;return c.set("username",s.username),c.set("password",s.password),c.set("email",s.email),c.signUp(null,{success:function(t){var s=new e;s.setPointerMappingSimple(a),n.resolve({results:s.decodeData(s.stripObject(t)),code:200}),r.$apply()},error:function(e,t){o(t.code),n.resolve({results:{error:t.message,code:t.code}}),r.$apply()}}),n.promise},e.prototype.login=function(s){Parse.User.current()&&Parse.User.logOut();var n=t.defer();return Parse.User.logIn(s.username,s.password,{success:function(t){var s=new e;s.setPointerMappingSimple(a),n.resolve({results:s.decodeData(s.stripObject(t)),code:200}),r.$apply()},error:function(e,t){o(t.code),n.resolve({results:{error:t.message,code:t.code}}),r.$apply()}}),n.promise},e.prototype.getCurrentUser=function(){return Parse.User.current()},e.prototype.logout=function(){Parse.User.logOut()},e.prototype.updateUser=function(e){var s=Parse.User.current();if(s)n=s.attributes.username;else var n=e.username;var a=t.defer();return Parse.User.logIn(e.username,e.oldPassword,{success:function(e){s=Parse.User.current(),s.set("password",e.password),s.set("email",e.email),s.save(null,{success:function(e){a.resolve({results:e,code:200}),r.$apply()},error:function(e,t){o(t.code),a.resolve({results:{error:t.message,code:t.code}}),r.$apply()}})},error:function(e,t){o(t.code),a.resolve({results:{error:t.message,code:t.code}}),r.$apply()}}),a.promise},e.prototype.post=function(s,n){var c=new(Parse.Object.extend(s)),p=t.defer();return e.prototype.encodeQuery(n),c.save(n,{success:function(t){var s=new e;s.setPointerMappingSimple(a),p.resolve({results:s.decodeData(s.stripObject(t)),code:200}),r.$apply()},error:function(e){o(e.code),p.resolve({results:{error:e.message,code:e.code}}),r.$apply()}}),p.promise},e.prototype.get=function(s,c){e.prototype.encodeQuery(c);for(var p=new Parse.Query(Parse.Object.extend(s)),u=t.defer(),i=Object.keys(c),l=0;l<i.length;l++)n[i[l]]&&(p[n[i[l]]]=c[i[l]]);return p.find({success:function(t){var s=new e;s.setPointerMappingSimple(a),u.resolve({results:s.decodeData(s.stripArray(t)),code:200}),r.$apply()},error:function(e){o(e.code),u.resolve({results:{error:e.message,code:e.code}}),r.$apply()}}),u.promise},e.prototype.put=function(s,n,c){var p=t.defer(),u=new Parse.Query(Parse.Object.extend(s));return e.prototype.encodeQuery(c),u.equalTo("objectId",n),u.first({success:function(t){var s=Object.keys(c);if(t){for(var o=0;o<s.length;o++)t.set(s[o],c[s[o]]);var n=t.save();n.then(function(){var t=new e;t.setPointerMappingSimple(a),n._resolved?(p.resolve({results:t.decodeData(t.stripArray(n._result)),code:200}),r.$apply()):(p.resolve({results:{error:"Failed to update",code:400}}),r.$apply())})}else p.resolve({results:{error:"Database.prototype object does not exist",code:404}}),r.$apply()},error:function(e){o(e.code),p.resolve({results:{error:e.message,code:e.code}}),r.$apply()}}),p.promise},e.prototype["delete"]=function(e,s){var n=t.defer(),a=new Parse.Query(Parse.Object.extend(e));return a.equalTo("objectId",s),a.first({success:function(e){e?e.destroy({success:function(e){n.resolve({results:{error:"Object "+e.id+" has been deleted"},code:200}),r.$apply()},error:function(e,t){o(t.code),n.resolve({results:{error:t.message,code:t.code}}),r.$apply()}}):(n.resolve({results:{error:"Object does not exist",code:404}}),r.$apply())},error:function(e){n.resolve({results:{error:e.message,code:e.code}}),r.$apply()}}),n.promise},e.prototype.uploadFile=function(e){var r=new Parse.File(e[0].name,e[0]),s=t.defer();return r.save().then(function(){s.resolve({results:r,code:200})},function(e){s.resolve({results:{error:e.reponseText,code:e.status}})}),s.promise}});